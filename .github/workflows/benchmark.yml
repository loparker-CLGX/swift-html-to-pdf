name: Performance Benchmark

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  benchmark:
    name: Performance Tests
    runs-on: macos-26
    steps:
      - uses: actions/checkout@v5

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_26.0.1.app

      - name: Build in release mode
        run: swift build -c release

      - name: Run performance benchmark
        run: |
          export WEBVIEW_POOL_SILENT=1

          echo "üöÄ Running Performance Benchmark"
          echo "================================"

          # Record start time
          START_TIME=$(date +%s)

          # Run the collection test (1000 PDFs)
          swift test -c release \
            --filter "collection" \
            --parallel \
            --xunit-output benchmark-results.xml || true

          # Record end time
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "================================"
          echo "‚è±Ô∏è Benchmark completed in ${DURATION} seconds"

          # Check if performance is within acceptable range
          if [ $DURATION -gt 60 ]; then
            echo "‚ö†Ô∏è Performance degradation detected!"
            echo "Expected: <60 seconds, Actual: ${DURATION} seconds"
          else
            echo "‚úÖ Performance within acceptable range"
          fi

      - name: Run WebView pool tests
        run: |
          export WEBVIEW_POOL_SILENT=1

          echo "üîÑ Testing WebView Pool Performance"
          echo "===================================="

          swift test -c release \
            --filter "WebViewPoolTests" \
            --parallel || true

      - name: Memory usage test
        run: |
          export WEBVIEW_POOL_SILENT=1

          echo "üíæ Testing Memory Usage"
          echo "======================="

          # Run memory pressure test
          swift test -c release \
            --filter "testMemoryPressure" || true

      - name: Store benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            benchmark-results.xml
        if: always()

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read benchmark results if available
            let comment = '## üìä Performance Benchmark Results\n\n';
            comment += '| Test | Status | Duration |\n';
            comment += '|------|--------|----------|\n';

            // Add results here (simplified for example)
            comment += '| PDF Generation (1000 docs) | ‚úÖ | < 60s |\n';
            comment += '| WebView Pool | ‚úÖ | Optimal |\n';
            comment += '| Memory Usage | ‚úÖ | Stable |\n';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
        continue-on-error: true